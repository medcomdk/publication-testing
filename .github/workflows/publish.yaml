name: MedCom document publish job

on:
  push:
    tags:
      - 'v.[0-9]+.[0-9]+.[0-9]+'   # Only runs on semantic tags (v.1.2.3)

env:
  WEB_APP_LOCATION: "ig/documentTest/"
  WEB_REPO: "medcomfhir-website"
  REGISTRY_REPO: "ig-registry"
  APP_AUTHOR_NAME: ${{ github.triggering_actor }}
  APP_AUTHOR_EMAIL: "fhir@medcom.dk"
  RELEASE_VERSION: ${{ github.ref_name }}

jobs:
  release:
    name: Transpile and publish to the IG release
    runs-on: ubuntu-latest
    container: ghcr.io/trifork/ig-publisher:1.8.25

    steps:
      - uses: actions/checkout@v4
        with:
          path: ig

      - name: Set Sushi config release YAML properties
        uses: fjogeleit/yaml-update-action@v0.16.0
        with:
          valueFile: ig/sushi-config.yaml
          commitChange: false
          createPR: false
          changes: |
            {
              "version": "${{ env.RELEASE_VERSION }}",
              "releaseLabel": "release"
            }

      - name: Update publication-request.json with the release version
        run: |
          echo "$(jq '
            .version = env.RELEASE_VERSION |
            .path |= sub("/[0-9\\.]+$"; "/" + env.RELEASE_VERSION)
          ' ig/publication-request.json)" > ig/publication-request.json

      - name: Print edited config files
        run: |
          echo "======================== sushi-config.yaml        ========================"
          cat ig/sushi-config.yaml
          echo -n "\n\n======================== publication-request.json ========================\n"
          cat ig/publication-request.json

      - name: Generate app token
        id: token
        uses: actions/create-github-app-token@v2
        with:
          app-id: "1237461"
          private-key: ${{ secrets.PUBLISHER_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: "${{ env.WEB_REPO }},${{ env.REGISTRY_REPO }}"

      - name: Publish the implementation guide
        uses: trifork/ig-publisher/.github/actions/ig-publish@v1
        with:
          app-token: ${{ steps.token.outputs.token }}
          app-author-name: ${{ env.APP_AUTHOR_NAME }}
          app-author-email: ${{ env.APP_AUTHOR_EMAIL }}
          registry-repo: ${{ github.repository_owner }}/${{ env.REGISTRY_REPO }}
          web-repo: ${{ github.repository_owner }}/${{ env.WEB_REPO }}
          web-source: ${{ env.WEB_APP_LOCATION }}
          web-commit: "false"